#!/bin/bash
set -e

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ wg-easy ==="
if ! docker ps | grep -q wg-easy; then
  echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä wg-easy –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º..."
  docker start wg-easy
else
  echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä wg-easy —É–∂–µ –∑–∞–ø—É—â–µ–Ω."
fi

echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±—Ä–æ—Å–∞ –ø–æ—Ä—Ç–∞ 51821 ==="
if ! docker inspect wg-easy | grep -q '"HostPort": "51821"'; then
  echo "‚ùå –ü–æ—Ä—Ç 51821 –Ω–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º -p 51821:51821"
  exit 1
else
  echo "‚úÖ –ü–æ—Ä—Ç 51821 –ø—Ä–æ–±—Ä–æ—à–µ–Ω."
fi

echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–ª—É—à–∞–µ—Ç –ª–∏ –ø–æ—Ä—Ç ==="
LISTEN_LINE=$(ss -tuln | grep ':51821' || true)
if [[ -z "$LISTEN_LINE" ]]; then
  echo "‚ùå –ü–æ—Ä—Ç 51821 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è. –ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º."
  exit 1
fi

if echo "$LISTEN_LINE" | grep -q '127.0.0.1'; then
  echo "‚ö†Ô∏è  –ü–æ—Ä—Ç —Å–ª—É—à–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ localhost. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ."
  echo "–ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—É–±–ª–∏—á–Ω—ã–º –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–∞ (0.0.0.0:51821)"
  exit 1
else
  echo "‚úÖ –ü–æ—Ä—Ç —Å–ª—É—à–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ: $(echo "$LISTEN_LINE")"
fi

echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª UFW ==="
if sudo ufw status | grep -q 51821; then
  echo "‚úÖ –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –ø–æ—Ä—Ç–∞ 51821 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
else
  echo "üîß –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ: sudo ufw allow 51821/tcp"
  sudo ufw allow 51821/tcp
fi

echo -e "\n=== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ==="
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "üéØ –ï—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, —Ç–µ–ø–µ—Ä—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å wg-easy –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ:"
echo "üëâ http://$SERVER_IP:51821"
